<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ì„œê´€ ì‹œìŠ¤í…œ</title>
    <style>
        /* --- CSS Reset & Basic Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', Arial, sans-serif; background-color: #fff; color: #333; }
        a { text-decoration: none; color: inherit; }

        /* --- Theme Colors --- */
        :root {
            --main-color: #2c3e50; /* ì§„í•œ ë„¤ì´ë¹„ */
            --accent-color: #3498db; /* ë°ì€ ë¸”ë£¨ */
            --bg-color: #f5f7fa;
        }

        /* --- Header --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px; border-bottom: 2px solid #eee;
        }
        .logo { font-size: 24px; font-weight: bold; letter-spacing: -0.5px; color: var(--main-color); cursor: pointer; }
        .user-menu { display: flex; gap: 15px; }
        .btn {
            padding: 8px 16px; border: 1px solid var(--main-color); border-radius: 4px;
            font-size: 14px; font-weight: 600; background: #fff; color: var(--main-color);
            cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { background: var(--main-color); color: #fff; }

        /* --- Main Layout --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* --- Search Bar --- */
        .search-box { display: flex; margin: 30px 0; border: 2px solid #333; }
        .search-box input { flex: 1; padding: 15px; border: none; font-size: 16px; outline: none; }
        .search-box button { padding: 0 30px; background: #ddd; border: none; border-left: 2px solid #333; cursor: pointer; font-weight: bold; font-size: 16px; }

        /* --- Notice / Section --- */
        .notice-bar { background-color: #f0f0f0; padding: 10px 15px; margin-bottom: 40px; border: 1px solid #ccc; font-size: 14px; }
        section { margin-bottom: 60px; }
        h2 { font-size: 20px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: var(--main-color); }

        /* --- Book Grid --- */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 30px; }

        /* ì±… ì¹´ë“œ ìŠ¤íƒ€ì¼ (í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½) */
        .book-card {
            border: 1px solid #ccc; padding: 15px; background: #fff; text-align: center;
            transition: transform 0.2s; cursor: pointer;
            display: flex; flex-direction: column;
        }
        .book-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent-color); }
        .book-img-placeholder { width: 100%; height: 250px; background-color: #eee; margin-bottom: 15px; overflow: hidden; }
        .book-img-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .book-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { font-size: 13px; color: #666; }

        /* =========================================
           [ëª¨ë‹¬(Modal) ê³µí†µ ìŠ¤íƒ€ì¼]
           ========================================= */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-window {
            background-color: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .close-modal {
            position: absolute; top: 10px; right: 20px; font-size: 28px; cursor: pointer; color: #999;
            transition: color 0.2s; z-index: 100;
        }
        .close-modal:hover { color: var(--main-color); }

        /* --- ë¡œê·¸ì¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #loginModal .modal-window { padding: 40px; width: 90%; max-width: 380px; }
        .login-title { text-align: center; font-size: 24px; font-weight: bold; color: var(--main-color); margin-bottom: 30px; }
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .input-field { width: 100%; height: 45px; padding: 10px 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .login-submit-btn { width: 100%; height: 45px; background-color: var(--main-color); color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .modal-links { margin-top: 20px; text-align: center; font-size: 13px; color: #666; }

        /* --- ì±… ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        #bookDetailModal .modal-window {
            width: 800px; max-width: 90%; display: flex; flex-direction: row; min-height: 400px;
        }
        .bd-cover-area {
            width: 40%; background-color: #f8f8f8; display: flex;
            justify-content: center; align-items: center; padding: 20px;
        }
        .bd-cover-area img { width: 100%; max-width: 200px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .bd-info-area {
            width: 60%; padding: 40px 30px; display: flex; flex-direction: column;
        }
        .bd-title { font-size: 22px; font-weight: bold; margin-bottom: 10px; color: var(--main-color); line-height: 1.3;}
        .bd-meta { font-size: 14px; color: #666; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .bd-meta span { margin-right: 10px; }
        .bd-desc { font-size: 14px; color: #444; line-height: 1.6; flex: 1; overflow-y: auto; max-height: 200px; margin-bottom: 20px; }
        .bd-btn-group { margin-top: auto; }
        .loan-btn {
            width: 100%; padding: 15px; background-color: var(--accent-color); color: #fff;
            border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s;
        }
        .loan-btn:hover { background-color: #2980b9; }

        /* ë°˜ì‘í˜•: ëª¨ë°”ì¼ì—ì„œëŠ” ìƒì„¸ ëª¨ë‹¬ ì„¸ë¡œ ë°°ì¹˜ */
        @media (max-width: 700px) {
            #bookDetailModal .modal-window { flex-direction: column; overflow-y: auto; height: 90%; }
            .bd-cover-area { width: 100%; height: 250px; }
            .bd-cover-area img { height: 100%; width: auto; }
            .bd-info-area { width: 100%; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.href='/'">LIBRARY SYSTEM</div>
    <div class="user-menu">
        <!-- ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆì„ ë•Œ -->
        <th:block th:if="${session.loginUser == null}">
            <button onclick="openLoginModal()" class="btn">LOGIN</button>
        </th:block>
        <!-- ë¡œê·¸ì¸ ë˜ì–´ ìˆì„ ë•Œ -->
        <th:block th:if="${session.loginUser != null}">
            <span th:text="${session.loginUser.name} + 'ë‹˜'" style="align-self: center; font-weight: bold; margin-right: 10px;"></span>
            <a href="/mypage" class="btn">MY INFO</a>
            <a href="/logout" class="btn">LOGOUT</a>
        </th:block>
    </div>
</header>

<div class="container">
    <form action="/search" method="get" class="search-box">
        <input type="text" name="keyword" placeholder="ì±… ì œëª©, ì €ì ê²€ìƒ‰">
        <button type="submit">ğŸ” Search</button>
    </form>

    <div class="notice-bar">
        <span class="notice-label" style="font-weight:bold">NOTICE:</span> ë„ì„œê´€ ì´ìš© ì‹œê°„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
    </div>

    <section>
        <h2 th:text="${sectionTitle}">ë² ìŠ¤íŠ¸ì…€ëŸ¬ / ì¶”ì²œ ë„ì„œ</h2>
        <div class="book-grid">
            <!--
                ì±… ì¹´ë“œ í´ë¦­ ì‹œ openBookDetail() í˜¸ì¶œ
                data-* ì†ì„±ì„ í†µí•´ ì±… ì •ë³´ë¥¼ HTML ìš”ì†Œì— ì‹¬ì–´ë‘ 
            -->
            <div th:each="book : ${recommendList}" class="book-card"
                 onclick="openBookDetail(this)"
                 th:attr="data-isbn=${book.isbn13},
                          data-title=${book.title},
                          data-author=${book.author},
                          data-publisher=${book.publisher},
                          data-pubdate=${book.pubDate},
                          data-description=${book.description},
                          data-cover=${book.cover}">

                <div class="book-img-placeholder">
                    <img th:if="${book.cover}" th:src="${book.cover}" alt="í‘œì§€">
                    <span th:unless="${book.cover}">No Image</span>
                </div>
                <div class="book-title" th:text="${book.title}">ì±… ì œëª©</div>
                <div class="book-author" th:text="${book.author}">ì‘ê°€ ì´ë¦„</div>
            </div>

            <!-- ëª©ë¡ ì—†ìŒ ì²˜ë¦¬ -->
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: #f9f9f9; border-radius: 8px;"
                 th:if="${#lists.isEmpty(recommendList)}">
                <h3>ğŸ“š ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h3>
                <p style="color: #666; margin-top: 10px;">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </section>
</div>

<!-- =========================================
     1. ë¡œê·¸ì¸ ëª¨ë‹¬ (Login Modal)
     ========================================= -->
<div id="loginModal" class="modal-overlay" onclick="closeLoginModal(event)">
    <div class="modal-window">
        <span class="close-modal" onclick="forceCloseLoginModal()">&times;</span>
        <div class="login-title">LOGIN</div>
        <form action="/login" method="post">
            <div class="input-group">
                <input type="text" name="username" class="input-field" placeholder="ì•„ì´ë””" required>
                <input type="password" name="password" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            </div>
            <button type="submit" class="login-submit-btn">ë¡œê·¸ì¸</button>
        </form>
        <div class="modal-links">
            <a href="/signup" style="color: var(--accent-color); font-weight: bold;">íšŒì›ê°€ì…</a>
        </div>
    </div>
</div>

<!-- =========================================
     2. ì±… ìƒì„¸ ëª¨ë‹¬ (Book Detail Modal)
     ========================================= -->
<div id="bookDetailModal" class="modal-overlay" onclick="closeBookDetailModal(event)">
    <div class="modal-window">
        <span class="close-modal" onclick="forceCloseBookDetailModal()">&times;</span>

        <!-- ì™¼ìª½: ì»¤ë²„ ì´ë¯¸ì§€ -->
        <div class="bd-cover-area">
            <img id="modalCover" src="" alt="Book Cover">
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì •ë³´ ë° ëŒ€ì¶œ ë²„íŠ¼ -->
        <div class="bd-info-area">
            <h3 id="modalTitle" class="bd-title">ì±… ì œëª©</h3>
            <div class="bd-meta">
                <span id="modalAuthor">ì €ì</span> |
                <span id="modalPublisher">ì¶œíŒì‚¬</span> |
                <span id="modalPubDate">ì¶œíŒì¼</span>
            </div>
            <div id="modalDescription" class="bd-desc">
                ì±… ì„¤ëª…ì´ ë“¤ì–´ê°€ëŠ” ê³³ì…ë‹ˆë‹¤...
            </div>

            <div class="bd-btn-group">
                <!-- AJAX ì‚¬ìš©ì„ ìœ„í•´ form ì œê±°í•˜ê³  inputë§Œ ìœ ì§€ -->
                <input type="hidden" id="modalIsbnInput">
                <button class="loan-btn" onclick="handleLoan()">ëŒ€ì¶œí•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    /* =========================================
       [ì „ì—­ ë³€ìˆ˜ ì„¤ì •]
       ========================================= */
    const IS_LOGGED_IN = [[${session.loginUser != null}]];

    /* =========================================
       [ëª¨ë‹¬ ê³µí†µ í•¨ìˆ˜]
       ========================================= */
    function openElement(id) { document.getElementById(id).style.display = 'flex'; }
    function closeElement(event, id) {
        if (event.target === document.getElementById(id)) {
            document.getElementById(id).style.display = 'none';
        }
    }
    function forceCloseElement(id) { document.getElementById(id).style.display = 'none'; }

    /* ë¡œê·¸ì¸ ëª¨ë‹¬ ì œì–´ */
    function openLoginModal() { openElement('loginModal'); }
    function closeLoginModal(e) { closeElement(e, 'loginModal'); }
    function forceCloseLoginModal() { forceCloseElement('loginModal'); }

    /* ì±… ìƒì„¸ ëª¨ë‹¬ ì œì–´ */
    function openBookDetailModal() { openElement('bookDetailModal'); }
    function closeBookDetailModal(e) { closeElement(e, 'bookDetailModal'); }
    function forceCloseBookDetailModal() { forceCloseElement('bookDetailModal'); }

    /* =========================================
       [ì±… ìƒì„¸ ì •ë³´ ë¡œì§]
       ========================================= */
    function openBookDetail(element) {
        const title = element.getAttribute('data-title');
        const author = element.getAttribute('data-author');
        const publisher = element.getAttribute('data-publisher');
        const pubDate = element.getAttribute('data-pubdate');
        const description = element.getAttribute('data-description');
        const cover = element.getAttribute('data-cover');
        const isbn = element.getAttribute('data-isbn');

        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalAuthor').innerText = author;
        document.getElementById('modalPublisher').innerText = publisher;
        document.getElementById('modalPubDate').innerText = pubDate;
        document.getElementById('modalDescription').innerText = description ? description : "ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";

        const imgElem = document.getElementById('modalCover');
        if (cover && cover !== 'null') {
            imgElem.src = cover;
        } else {
            imgElem.src = 'https://via.placeholder.com/200x300?text=No+Image';
        }

        // ISBN ì„¤ì • (ëŒ€ì¶œ ì‹œ ì‚¬ìš©)
        document.getElementById('modalIsbnInput').value = isbn;

        openBookDetailModal();
    }

    /* =========================================
       [ëŒ€ì¶œ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (AJAX fetch ì‚¬ìš©)]
       ========================================= */
    function handleLoan() {
        // 1. ë¡œê·¸ì¸ ì—¬ë¶€ ì²´í¬
        if (!IS_LOGGED_IN) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
            forceCloseBookDetailModal();
            openLoginModal();
            return;
        }

        // 2. ëŒ€ì¶œ í™•ì¸
        if (!confirm('ì´ ì±…ì„ ëŒ€ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const isbn = document.getElementById('modalIsbnInput').value;

        // 3. fetch APIë¡œ ë¹„ë™ê¸° ìš”ì²­ ì „ì†¡
        fetch('/loan', {
            method: 'POST',
            headers: {
                // Controllerê°€ @RequestParamìœ¼ë¡œ ë°›ìœ¼ë¯€ë¡œ form-urlencoded í˜•ì‹ ì‚¬ìš©
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'isbn=' + encodeURIComponent(isbn)
        })
        .then(response => response.json()) // ì„œë²„ ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±
        .then(data => {
            console.log("ì„œë²„ ì‘ë‹µ:", data); // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥

            if (data.success) {
                // ì„±ê³µ ì‹œ ë©”ì‹œì§€ ì¶œë ¥ í›„ ìƒˆë¡œê³ ì¹¨
                alert(data.message);
                location.reload();
            } else {
                // ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ë§Œ ì¶œë ¥ (ìƒˆë¡œê³ ì¹¨ X)
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Fetch ì—ëŸ¬:', error);
            alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    /* =========================================
       [í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸]
       ========================================= */
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('signupSuccess')) {
            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë°”ë¡œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
            openLoginModal();
            history.replaceState({}, null, location.pathname);
        }
    };
</script>

</body>
</html>
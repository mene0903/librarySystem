<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ì„œê´€ ì‹œìŠ¤í…œ</title>
    <style>
        /* --- CSS Reset & Basic Styles --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        a { text-decoration: none; color: inherit; }

        /* --- Theme Colors --- */
        :root {
            --main-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f5f7fa;
            --text-gray: #666;
        }

        /* --- Header --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 25px 50px;
            border-bottom: 1px solid #eee;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .logo { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; color: var(--main-color); cursor: pointer; }
        .user-menu { display: flex; gap: 20px; align-items: center; }
        .btn {
            padding: 10px 20px;
            border: 1px solid var(--main-color); border-radius: 6px;
            font-size: 14px; font-weight: 600; background: #fff; color: var(--main-color);
            cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { background: var(--main-color); color: #fff; }

        /* --- Main Layout --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; }

        /* --- Search Bar --- */
        .search-box { display: flex; margin: 0 0 40px 0; border: 2px solid #333; border-radius: 8px; overflow: hidden; }
        .search-box input { flex: 1; padding: 18px; border: none; font-size: 16px; outline: none; }
        .search-box button { padding: 0 40px; background: #333; color: #fff; border: none; cursor: pointer; font-weight: bold; font-size: 16px; transition: background 0.2s; }
        .search-box button:hover { background: #555; }

        /* --- Category Navigation --- */
        .category-nav {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 20px;
            margin-bottom: 50px;
            border-bottom: 1px solid #eee;
        }
        .category-nav::-webkit-scrollbar { height: 6px; }
        .category-nav::-webkit-scrollbar-track { background: #f1f1f1; }
        .category-nav::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        .cat-btn {
            padding: 10px 22px;
            border: 1px solid #ddd;
            border-radius: 30px;
            background-color: #fff;
            color: #555;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex; align-items: center; flex-shrink: 0;
        }
        .cat-btn:hover { background-color: #f8f9fa; border-color: #bbb; }
        .cat-btn.active { background-color: var(--main-color); color: #fff; border-color: var(--main-color); box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); font-weight: 700; }

        .cat-btn.recommend { border-color: var(--accent-color); color: var(--accent-color); }
        .cat-btn.recommend.active { background-color: var(--accent-color); color: #fff; }

        section { margin-bottom: 80px; }
        h2 {
            font-size: 24px; margin-bottom: 30px;
            border-bottom: 2px solid #eee; padding-bottom: 15px;
            color: var(--main-color); font-weight: 700;
        }

        /* --- Book Grid --- */
        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 40px;
        }

        .book-card {
            border: 1px solid #eee;
            padding: 20px;
            background: #fff; text-align: center;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            display: flex; flex-direction: column;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .book-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--accent-color);
        }

        .book-img-placeholder {
            width: 100%; height: 280px;
            background-color: #f0f0f0; margin-bottom: 20px;
            border-radius: 8px; overflow: hidden;
        }
        .book-img-placeholder img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .book-card:hover img { transform: scale(1.05); }

        .book-title {
            font-size: 17px; font-weight: bold;
            margin-bottom: 8px;
            color: #222;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .book-author { font-size: 14px; color: var(--text-gray); }

        /* --- Modal Styles --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-window {
            background-color: #fff; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .close-modal {
            position: absolute; top: 20px; right: 25px; font-size: 32px;
            cursor: pointer; color: #aaa; transition: color 0.2s; z-index: 100;
        }
        .close-modal:hover { color: #333; }

        /* ë¡œê·¸ì¸ ëª¨ë‹¬ */
        #loginModal .modal-window { padding: 50px; width: 90%; max-width: 420px; }
        .login-title { text-align: center; font-size: 28px; font-weight: 800; color: var(--main-color); margin-bottom: 40px; }
        .input-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .input-field { width: 100%; height: 50px; padding: 0 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .login-submit-btn { width: 100%; height: 50px; background-color: var(--main-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }

        /* [ìˆ˜ì •] ì±… ìƒì„¸ ëª¨ë‹¬ ì´ë¯¸ì§€ ì˜ì—­ */
        #bookDetailModal .modal-window { width: 900px; max-width: 95%; display: flex; flex-direction: row; height: 600px; }

        .bd-cover-area {
            width: 45%;
            background-color: #f0f0f0; /* ë°°ê²½ìƒ‰ ì‚´ì§ ì§„í•˜ê²Œ */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; /* ì—¬ë°± ì œê±°! (ê½‰ ì°¨ê²Œ) */
            overflow: hidden; /* ì‚ì ¸ë‚˜ê° ë°©ì§€ */
        }

        .bd-cover-area img {
            width: 100%;  /* ê°€ë¡œ ê½‰ ì±„ì›€ */
            height: 100%; /* ì„¸ë¡œ ê½‰ ì±„ì›€ */
            object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ë§ì¶¤ */
            /* ë§Œì•½ ë¹„ìœ¨ ë¬´ì‹œí•˜ê³  ê½‰ ì±„ìš°ë ¤ë©´ object-fit: cover; ì‚¬ìš© */
        }

        .bd-info-area { width: 55%; padding: 50px 40px; display: flex; flex-direction: column; overflow-y: auto; }
        .bd-title {
            font-size: 28px; font-weight: 800; line-height: 1.4;
            margin-bottom: 15px; color: var(--main-color);
        }
        .bd-meta {
            font-size: 15px; color: #555; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;
            display: flex; flex-wrap: wrap; gap: 10px;
        }
        .bd-desc {
            font-size: 16px; color: #444; line-height: 1.8;
            flex: 1; overflow-y: auto; margin-bottom: 30px;
            padding-right: 10px;
        }
        .loan-btn {
            width: 100%; padding: 18px;
            background-color: var(--accent-color); color: #fff; border: none; border-radius: 8px;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.2s;
        }
        .loan-btn:hover { background-color: #2980b9; }

        @media (max-width: 768px) {
            #bookDetailModal .modal-window { flex-direction: column; height: 90%; }
            .bd-cover-area { width: 100%; height: 350px; padding: 0; } /* ëª¨ë°”ì¼ì—ì„œë„ ê½‰ ì°¨ê²Œ */
            .bd-info-area { width: 100%; padding: 30px 20px; }
            .category-nav { padding-bottom: 10px; }
            .book-grid { gap: 20px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.href='/'">LIBRARY SYSTEM</div>
    <div class="user-menu">
        <th:block th:if="${session.loginUser == null}">
            <button onclick="openLoginModal()" class="btn">ë¡œê·¸ì¸</button>
        </th:block>
        <th:block th:if="${session.loginUser != null}">
            <span th:text="${session.loginUser.name} + 'ë‹˜'" style="font-weight: bold; font-size:15px;"></span>
            <a href="/mypage" class="btn">ë‚´ ì •ë³´</a>
            <a href="/logout" class="btn" style="border-color:#ddd; color:#666;">ë¡œê·¸ì•„ì›ƒ</a>
        </th:block>
    </div>
</header>

<div class="container">
    <form action="/search" method="get" class="search-box">
        <input type="text" name="keyword" placeholder="ì°¾ê³  ì‹¶ì€ ì±… ì œëª©ì´ë‚˜ ì €ìë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button type="submit">ê²€ìƒ‰</button>
    </form>

    <nav class="category-nav">
        <a href="/?categoryId=0"
           class="cat-btn"
           th:classappend="${(currentCategory == 0 or currentCategory == null) and currentMode != 'recommend'} ? 'active'">
            ğŸ† ì¢…í•© ë² ìŠ¤íŠ¸
        </a>

        <th:block th:if="${session.loginUser != null}">
            <a href="/?mode=recommend"
               class="cat-btn recommend"
               th:classappend="${currentMode == 'recommend'} ? 'active'">
                âœ¨ <span th:text="${session.loginUser.name}">User</span>ë‹˜ ì¶”ì²œ
            </a>
        </th:block>

        <a href="/?categoryId=1" class="cat-btn" th:classappend="${currentCategory == 1} ? 'active'">ì†Œì„¤/ì‹œ</a>
        <a href="/?categoryId=170" class="cat-btn" th:classappend="${currentCategory == 170} ? 'active'">ê²½ì œê²½ì˜</a>
        <a href="/?categoryId=987" class="cat-btn" th:classappend="${currentCategory == 987} ? 'active'">ê³¼í•™</a>
        <a href="/?categoryId=656" class="cat-btn" th:classappend="${currentCategory == 656} ? 'active'">ì¸ë¬¸</a>
        <a href="/?categoryId=336" class="cat-btn" th:classappend="${currentCategory == 336} ? 'active'">ìê¸°ê³„ë°œ</a>
        <a href="/?categoryId=55889" class="cat-btn" th:classappend="${currentCategory == 55889} ? 'active'">ì—ì„¸ì´</a>
        <a href="/?categoryId=351" class="cat-btn" th:classappend="${currentCategory == 351} ? 'active'">IT/ì»´í“¨í„°</a>
        <a href="/?categoryId=74" class="cat-btn" th:classappend="${currentCategory == 74} ? 'active'">ì—­ì‚¬</a>
    </nav>

    <section>
        <h2 th:text="${sectionTitle}">ë„ì„œ ëª©ë¡</h2>
        <div class="book-grid">
            <div th:each="book : ${recommendList}" class="book-card"
                 onclick="openBookDetail(this)"
                 th:attr="data-isbn=${book.isbn13},
                          data-title=${book.title},
                          data-author=${book.author},
                          data-publisher=${book.publisher},
                          data-pubdate=${book.pubDate},
                          data-description=${book.description},
                          data-cover=${book.cover},
                          data-rank=${book.customerReviewRank}">

                <div class="book-img-placeholder">
                    <img th:if="${book.cover}" th:src="${book.cover}" alt="í‘œì§€">
                    <span th:unless="${book.cover}">ì´ë¯¸ì§€ ì—†ìŒ</span>
                </div>
                <div class="book-title" th:text="${book.title}">ì±… ì œëª©</div>
                <div class="book-author" th:text="${book.author}">ì‘ê°€ ì´ë¦„</div>
            </div>

            <div style="grid-column: 1 / -1; text-align: center; padding: 80px 0; color: #999;"
                 th:if="${#lists.isEmpty(recommendList)}">
                <h3 style="font-size:24px; margin-bottom:10px;">ğŸ“š ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h3>
                <p>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </section>
</div>

<div id="loginModal" class="modal-overlay" onclick="closeLoginModal(event)">
    <div class="modal-window">
        <span class="close-modal" onclick="forceCloseLoginModal()">&times;</span>
        <div class="login-title">LOGIN</div>
        <form action="/login" method="post">
            <div class="input-group">
                <input type="text" name="username" class="input-field" placeholder="ì•„ì´ë””" required>
                <input type="password" name="password" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            </div>
            <button type="submit" class="login-submit-btn">ë¡œê·¸ì¸</button>
        </form>
        <div class="modal-links" style="margin-top:20px; text-align:center;">
            <a href="/signup" style="color: var(--accent-color); font-weight: bold; font-size:14px;">íšŒì›ê°€ì… í•˜ê¸°</a>
        </div>
    </div>
</div>

<div id="bookDetailModal" class="modal-overlay" onclick="closeBookDetailModal(event)">
    <div class="modal-window">
        <span class="close-modal" onclick="forceCloseBookDetailModal()">&times;</span>
        <div class="bd-cover-area">
            <img id="modalCover" src="" alt="Book Cover">
        </div>
        <div class="bd-info-area">
            <h3 id="modalTitle" class="bd-title">ì±… ì œëª©</h3>
            <div class="bd-meta">
                <span id="modalAuthor">ì €ì</span>
                <span style="color:#ddd">|</span>
                <span id="modalPublisher">ì¶œíŒì‚¬</span>
                <span style="color:#ddd">|</span>
                <span id="modalPubDate">ì¶œíŒì¼</span>
                <span id="modalRankArea" style="display:none; margin-left:10px;">
                     â­ <span id="modalRank" class="bd-rank" style="color:#f39c12; font-weight:bold;"></span>
                </span>
            </div>
            <div id="modalDescription" class="bd-desc">
                ì±… ì„¤ëª…ì´ ë“¤ì–´ê°€ëŠ” ê³³ì…ë‹ˆë‹¤...
            </div>
            <div class="bd-btn-group" style="margin-top:auto;">
                <input type="hidden" id="modalIsbnInput">
                <button class="loan-btn" onclick="handleLoan()">ëŒ€ì¶œ ì‹ ì²­í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const IS_LOGGED_IN = [[${session.loginUser != null}]];

    function openElement(id) { document.getElementById(id).style.display = 'flex'; }
    function closeElement(event, id) {
        if (event.target === document.getElementById(id)) {
            document.getElementById(id).style.display = 'none';
        }
    }
    function forceCloseElement(id) { document.getElementById(id).style.display = 'none'; }

    function openLoginModal() { openElement('loginModal'); }
    function closeLoginModal(e) { closeElement(e, 'loginModal'); }
    function forceCloseLoginModal() { forceCloseElement('loginModal'); }

    function openBookDetailModal() { openElement('bookDetailModal'); }
    function closeBookDetailModal(e) { closeElement(e, 'bookDetailModal'); }
    function forceCloseBookDetailModal() { forceCloseElement('bookDetailModal'); }

    function openBookDetail(element) {
        const title = element.getAttribute('data-title');
        const author = element.getAttribute('data-author');
        const publisher = element.getAttribute('data-publisher');
        const pubDate = element.getAttribute('data-pubdate');
        const description = element.getAttribute('data-description');
        const cover = element.getAttribute('data-cover');
        const isbn = element.getAttribute('data-isbn');
        const rank = element.getAttribute('data-rank');

        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalAuthor').innerText = author;
        document.getElementById('modalPublisher').innerText = publisher;
        document.getElementById('modalPubDate').innerText = pubDate;

        const rankArea = document.getElementById('modalRankArea');
        const rankText = document.getElementById('modalRank');

        if (rank && parseFloat(rank) > 0) {
            rankText.innerText = rank;
            rankArea.style.display = 'inline';
        } else {
            rankArea.style.display = 'none';
        }

        document.getElementById('modalDescription').innerText = description ? description : "ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";

        const imgElem = document.getElementById('modalCover');
        if (cover && cover !== 'null') {
            imgElem.src = cover;
        } else {
            imgElem.src = 'https://via.placeholder.com/200x300?text=No+Image';
        }
        document.getElementById('modalIsbnInput').value = isbn;
        openBookDetailModal();
    }

    function handleLoan() {
        if (!IS_LOGGED_IN) {
            if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ ì°½ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                forceCloseBookDetailModal();
                openLoginModal();
            }
            return;
        }
        if (!confirm('ì´ ì±…ì„ ëŒ€ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const isbn = document.getElementById('modalIsbnInput').value;
        fetch('/loan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'isbn=' + encodeURIComponent(isbn)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Fetch ì—ëŸ¬:', error);
            alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.has('signupSuccess')) {
            alert('í™˜ì˜í•©ë‹ˆë‹¤! íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
            openLoginModal();
            history.replaceState({}, null, location.pathname);
        }

        if (urlParams.has('message')) {
            alert(urlParams.get('message'));
            history.replaceState({}, null, location.pathname);
        }

        if (urlParams.has('loginError')) {
            alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            openLoginModal();
            history.replaceState({}, null, location.pathname);
        }
    };
</script>

</body>
</html>
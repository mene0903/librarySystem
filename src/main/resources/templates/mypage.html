<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Library My Page</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ìœ ì§€) --- */
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; background: #ffffff; color: #333; }

        /* --- Header Style (ìœ ì§€) --- */
        .custom-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background-color: #fff; }
        .header-logo { font-size: 24px; font-weight: 700; color: #1e4b75; text-decoration: none; letter-spacing: -0.5px; }
        .header-menu { display: flex; align-items: center; gap: 10px; }
        .header-username { font-weight: 600; font-size: 16px; color: #333; margin-right: 15px; }
        .header-btn { background: #fff; border: 1px solid #333; border-radius: 4px; padding: 6px 16px; font-size: 13px; font-weight: 700; color: #1e4b75; cursor: pointer; text-decoration: none; transition: all 0.2s; display: inline-block; }
        .header-btn:hover { background-color: #f8f9fa; }

        /* --- Layout & List (ìœ ì§€) --- */
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .profile-card { background: #f8f9fa; padding: 30px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .profile-info { display: flex; align-items: center; gap: 20px; }
        .profile-avatar { width: 60px; height: 60px; background: #e1e7ef; color: #1e4b75; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; }
        .profile-text h1 { margin: 0; font-size: 22px; color: #333; }
        .profile-text p { margin: 5px 0 0 0; color: #666; font-size: 14px; }
        .edit-btn { padding: 10px 20px; background: #1e4b75; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .edit-btn:hover { background: #163a5c; }
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #111; border-left: 4px solid #1e4b75; padding-left: 12px; }
        .loan-list { display: flex; flex-direction: column; gap: 20px; }
        .loan-item { background: white; padding: 20px; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: flex-start; gap: 20px; }
        .book-cover { width: 80px; height: 120px; object-fit: cover; background: #eee; border: 1px solid #ddd; flex-shrink: 0; }
        .book-info { flex: 1; display: flex; flex-direction: column; justify-content: center; padding-top: 5px; }
        .book-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; color: #111; }
        .book-author { font-size: 14px; color: #666; margin-bottom: 10px; }
        .book-dates { font-size: 13px; color: #555; background: #f9f9f9; padding: 8px; border-radius: 4px; display: inline-block; }
        .date-label { font-weight: 600; margin-right: 5px; }
        .action-btns { align-self: center; display: flex; flex-direction: column; gap: 8px; }
        .action-btn { width: 80px; padding: 8px 0; font-size: 13px; font-weight: 600; border-radius: 4px; cursor: pointer; border: 1px solid #333; }
        .renew-btn { background: #fff; color: #333; }
        .renew-btn:hover { background: #f0f0f0; }
        .return-btn { background: #dc2626; color: white; border-color: #dc2626; }
        .return-btn:hover { background: #b91c1c; }

        /* --- Modal Styles --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1000; }
        .modal-window { width: 400px; background: white; padding: 30px; border-radius: 12px; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block; }
        .form-input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        .save-btn { width: 100%; padding: 12px; background: #1e4b75; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .delete-link { margin-top: 15px; text-align: center; font-size: 12px; color: #dc2626; cursor: pointer; text-decoration: underline; }

        /* [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ í† ê¸€ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .pw-toggle-link {
            font-size: 13px; color: #666; text-decoration: underline; cursor: pointer;
            display: inline-block; margin-bottom: 15px; background: none; border: none; padding: 0;
        }
        .pw-toggle-link:hover { color: #333; }

        #passwordSection {
            background-color: #f9f9f9; padding: 15px; border-radius: 8px;
            margin-bottom: 15px; border: 1px solid #eee; display: none;
        }

    </style>
</head>

<body>

<header class="custom-header">
    <a href="/" class="header-logo">LIBRARY SYSTEM</a>
    <div class="header-menu">
        <span class="header-username">
            <span th:text="${session.loginUser.name}">db</span>ë‹˜
        </span>
        <a href="/" class="header-btn">HOME</a>
        <a href="/logout" class="header-btn">LOGOUT</a>
    </div>
</header>

<div class="container">
    <div class="profile-card">
        <div class="profile-info">
            <div class="profile-avatar">
                <span th:text="${#strings.substring(session.loginUser.name, 0, 1)}">U</span>
            </div>
            <div class="profile-text">
                <h1>myPage</h1>
                <p>í™˜ì˜í•©ë‹ˆë‹¤, <span th:text="${session.loginUser.name}">User</span>ë‹˜!</p>
            </div>
        </div>
        <button class="edit-btn" onclick="openEditModal()">ë‚´ ì •ë³´ ìˆ˜ì •</button>
    </div>

    <div class="section-title">í˜„ì¬ ëŒ€ì¶œì¤‘ì¸ ë„ì„œ</div>
    <div class="loan-list">
        <div th:each="book : ${borrowedList}" class="loan-item">
            <img th:src="${book.cover}" class="book-cover" th:alt="${book.title}" />
            <div class="book-info">
                <div class="book-title" th:text="${book.title}">ì±… ì œëª©</div>
                <div class="book-author" th:text="${book.author}">ì €ì</div>
                <div class="book-dates">
                    <div><span class="date-label">ë°˜ë‚© ì˜ˆì •ì¼:</span><span th:text="${book.returnDate}">-</span></div>
                    <div style="margin-top: 4px;"><span class="date-label">ëŒ€ì¶œì¼:</span><span th:text="${book.loanDate}">-</span></div>
                </div>
            </div>
            <div class="action-btns">
                <button class="action-btn renew-btn" th:data-isbn="${book.isbn13}" onclick="handleRenew(this.dataset.isbn)">ì—°ì¥</button>
                <button class="action-btn return-btn" th:data-isbn="${book.isbn13}" onclick="handleReturn(this.dataset.isbn)">ë°˜ë‚©</button>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(borrowedList)}" style="text-align: center; padding: 40px; color: #999;">
            ëŒ€ì¶œ ì¤‘ì¸ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-window">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h3 style="margin-top: 0; margin-bottom: 20px;">íšŒì› ì •ë³´ ìˆ˜ì •</h3>

        <form action="/user/update" method="post">
            <div class="form-group">
                <label class="form-label">ID</label>
                <input type="text" name="id" class="form-input" th:value="${session.loginUser.id}" readonly style="background: #f5f5f5; color:#888;">
            </div>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-input" th:value="${session.loginUser.name}">
            </div>
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="text" name="phoneNumber" class="form-input" th:value="${session.loginUser.phoneNumber}">
            </div>

            <div style="text-align: right;">
                <button type="button" class="pw-toggle-link" onclick="togglePasswordSection()">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
            </div>

            <div id="passwordSection">
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" name="password" class="form-input"
                           id="pwInput" placeholder="ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                           onkeyup="checkPasswordMatch()">
                </div>

                <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input"
                           id="pwConfirmInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥"
                           onkeyup="checkPasswordMatch()">

                    <p id="pwMatchMsg" style="font-size: 12px; margin-top: 5px; min-height: 18px;"></p>
                    <p style="font-size: 11px; color: #999; margin-top: 5px;">* ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ê°€ ìœ ì§€ë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <button id="saveBtn" class="save-btn" type="submit">ì €ì¥í•˜ê¸°</button>
        </form>

        <div class="delete-link" onclick="confirmDelete()">íšŒì› íƒˆí‡´</div>
        <form id="deleteForm" action="/user/delete" method="post" style="display:none;">
            <input type="hidden" name="id" th:value="${session.loginUser.id}">
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error')) { alert(urlParams.get('error')); history.replaceState({}, null, location.pathname); }
        if (urlParams.get('message')) { alert(urlParams.get('message')); history.replaceState({}, null, location.pathname); }
        if (urlParams.get('updateSuccess')) { alert("ì •ë³´ ìˆ˜ì • ì™„ë£Œ"); history.replaceState({}, null, location.pathname); }
    });

    function openEditModal() { document.getElementById('editModal').style.display = 'flex'; }

    // [ìˆ˜ì •] ëª¨ë‹¬ ë‹«ì„ ë•Œ ë¹„ë°€ë²ˆí˜¸ ì°½ ì´ˆê¸°í™”
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('passwordSection').style.display = 'none';
        document.getElementById('pwInput').value = '';
    }

    // [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ í† ê¸€ í•¨ìˆ˜
    function togglePasswordSection() {
        const section = document.getElementById('passwordSection');
        const input = document.getElementById('pwInput');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            input.focus();
        } else {
            section.style.display = 'none';
            input.value = '';
        }
    }

    function handleRenew(isbn) {
        if(!confirm("ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (5ì¼ ì—°ì¥)")) return;
        fetch('/renew', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ isbn: isbn })
        }).then(res => res.json()).then(data => {
            alert(data.message); if(data.success) location.reload();
        }).catch(err => alert("í†µì‹  ì˜¤ë¥˜"));
    }

    function handleReturn(isbn) {
        if(!confirm("ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch('/return', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ isbn: isbn })
        }).then(res => res.json()).then(data => {
            alert(data.message); if(data.success) location.reload();
        }).catch(err => alert("í†µì‹  ì˜¤ë¥˜"));
    }

    function confirmDelete() {
        if(confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) document.getElementById('deleteForm').submit();
    }

    function checkPasswordMatch() {
    const pw = document.getElementById('pwInput').value;
    const pwConfirm = document.getElementById('pwConfirmInput').value;
    const msg = document.getElementById('pwMatchMsg');
    const saveBtn = document.getElementById('saveBtn');

    // 1. ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì•ˆ í•¨) -> í†µê³¼
    if (pw === "" && pwConfirm === "") {
        msg.innerText = "";
        saveBtn.disabled = false;
        saveBtn.style.opacity = 1;
        return;
    }

    // 2. ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì¤‘ì¸ë° í™•ì¸ë€ì´ ë¹„ì—ˆìœ¼ë©´ -> ëŒ€ê¸°
    if (pw !== "" && pwConfirm === "") {
        msg.innerText = "ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        msg.style.color = "#666";
        saveBtn.disabled = true;
        saveBtn.style.opacity = 0.5; // ë²„íŠ¼ íë¦¬ê²Œ
        return;
    }

    // 3. ì¼ì¹˜ ì—¬ë¶€ ê²€ì‚¬
    if (pw === pwConfirm) {
        msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤. âœ”ï¸";
        msg.style.color = "green";
        saveBtn.disabled = false;
        saveBtn.style.opacity = 1;
    } else {
        msg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. âŒ";
        msg.style.color = "red";
        saveBtn.disabled = true; // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
        saveBtn.style.opacity = 0.5;
    }
}

// [ìˆ˜ì •] ëª¨ë‹¬ ë‹«ì„ ë•Œ ì´ˆê¸°í™” ë¡œì§ì— ì¶”ê°€
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('passwordSection').style.display = 'none';

    // ì…ë ¥ê°’ ë° ë©”ì‹œì§€ ì´ˆê¸°í™”
    document.getElementById('pwInput').value = '';
    document.getElementById('pwConfirmInput').value = '';
    document.getElementById('pwMatchMsg').innerText = '';
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('saveBtn').style.opacity = 1;
}
</script>
</body>
</html>
